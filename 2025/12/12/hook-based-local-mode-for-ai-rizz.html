<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Hook-Based Local Mode for ai-rizz</title>
<!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="Hook-Based Local Mode for ai-rizz"> <meta name="author" content="Niko"> <meta property="og:locale" content="en_US"> <meta name="description" content="Recent Cursor builds on Mac ignore all git-ignored files, including those in .git/info/exclude. This broke ai-rizz‚Äôs local mode, which relies on .git/info/exclude to keep personal rules out of commits while making them visible to Cursor."> <meta property="og:description" content="Recent Cursor builds on Mac ignore all git-ignored files, including those in .git/info/exclude. This broke ai-rizz‚Äôs local mode, which relies on .git/info/exclude to keep personal rules out of commits while making them visible to Cursor."> <link rel="canonical" href="https://blog.cani.ne.jp/2025/12/12/hook-based-local-mode-for-ai-rizz.html"> <meta property="og:url" content="https://blog.cani.ne.jp/2025/12/12/hook-based-local-mode-for-ai-rizz.html"> <meta property="og:site_name" content="üê∂ Dog with a Dev Blog"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2025-12-12T00:00:00+00:00"> <meta name="twitter:card" content="summary"> <meta property="twitter:title" content="Hook-Based Local Mode for ai-rizz"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Niko"},"dateModified":"2025-12-12T00:00:00+00:00","datePublished":"2025-12-12T00:00:00+00:00","description":"Recent Cursor builds on Mac ignore all git-ignored files, including those in .git/info/exclude. This broke ai-rizz‚Äôs local mode, which relies on .git/info/exclude to keep personal rules out of commits while making them visible to Cursor.","headline":"Hook-Based Local Mode for ai-rizz","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.cani.ne.jp/2025/12/12/hook-based-local-mode-for-ai-rizz.html"},"url":"https://blog.cani.ne.jp/2025/12/12/hook-based-local-mode-for-ai-rizz.html"}</script> <!-- End Jekyll SEO tag --> <link type="application/atom+xml" rel="alternate" href="https://blog.cani.ne.jp/feed.xml" title="üê∂ Dog with a Dev Blog">
<link rel="shortcut icon" type="image/x-icon" href=""> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.css" integrity="sha384-OH8qNTHoMMVNVcKdKewlipV4SErXqccxxlg6HC9Cwjr5oZu2AdBej1TndeCirael" crossorigin="anonymous"> </head> <body a="light"> <main class="page-content" aria-label="Content"> <div class="w"> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> <header> <h1>Hook-Based Local Mode for ai-rizz</h1> <div style="display: flex; justify-content: space-between; align-items: center;"> <div> <span> a <a href="/categories/record/">record</a> </span> <span> by <a href="/authors/niko/">niko</a> </span> </div> <div> <span class="post-meta">2025-12-12</span> </div> </div> </header> <article> <p>Recent Cursor builds on Mac <a href="https://forum.cursor.com/t/cursor-2-1-50-ignores-rules-in-git-info-exclude-on-mac-not-on-windows-wsl/145695/4" target="_blank" rel="noopener">ignore all git-ignored files</a>, including those in <code class="language-plaintext highlighter-rouge">.git/info/exclude</code>. This broke <a href="https://github.com/texarkanine/ai-rizz" target="_blank" rel="noopener">ai-rizz</a>‚Äôs local mode, which relies on <code class="language-plaintext highlighter-rouge">.git/info/exclude</code> to keep personal rules out of commits while making them visible to Cursor.</p> <p>The fix: a <code class="language-plaintext highlighter-rouge">--hook-based-ignore</code> flag that uses a pre-commit hook instead of git excludes.</p> <h2 id="the-problem">The Problem</h2> <p>ai-rizz has two modes:</p> <ul> <li>
<strong>Local mode</strong>: Personal rules in <code class="language-plaintext highlighter-rouge">.cursor/rules/local/</code>, git-ignored via <code class="language-plaintext highlighter-rouge">.git/info/exclude</code>
</li> <li>
<strong>Commit mode</strong>: Team rules in <code class="language-plaintext highlighter-rouge">.cursor/rules/shared/</code>, committed to the repository</li> </ul> <p>The <code class="language-plaintext highlighter-rouge">.git/info/exclude</code> approach worked because it kept files out of commits without hiding them from Cursor. Mac Cursor‚Äôs new behavior broke this assumption.</p> <h2 id="the-solution">The Solution</h2> <p>When initialized with <code class="language-plaintext highlighter-rouge">--hook-based-ignore</code>, local mode:</p> <ol> <li>Skips adding files to <code class="language-plaintext highlighter-rouge">.git/info/exclude</code>
</li> <li>Installs a pre-commit hook that unstages local files before each commit</li> <li>Leaves files visible to Cursor (and <code class="language-plaintext highlighter-rouge">git status</code>)</li> </ol> <p>The hook reads the manifest dynamically to find which files to unstage:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Find local manifest in repo root</span>
<span class="nv">REPO_ROOT</span><span class="o">=</span><span class="si">$(</span>git rev-parse <span class="nt">--show-toplevel</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">pwd</span><span class="si">)</span>
<span class="nv">LOCAL_MANIFEST</span><span class="o">=</span><span class="s2">""</span>
<span class="k">for </span>file <span class="k">in</span> <span class="s2">"</span><span class="nv">$REPO_ROOT</span><span class="s2">"</span>/<span class="k">*</span>.local.skbd<span class="p">;</span> <span class="k">do</span>
    <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">LOCAL_MANIFEST</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span><span class="si">)</span> <span class="o">&amp;&amp;</span> <span class="nb">break
</span><span class="k">done</span>
<span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$LOCAL_MANIFEST</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0

<span class="c"># Parse target directory from manifest</span>
<span class="nv">MANIFEST_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$REPO_ROOT</span><span class="s2">/</span><span class="nv">$LOCAL_MANIFEST</span><span class="s2">"</span>
<span class="nv">TARGET_DIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-n1</span> <span class="s2">"</span><span class="nv">$MANIFEST_PATH</span><span class="s2">"</span> 2&gt;/dev/null | <span class="nb">cut</span> <span class="nt">-f2</span><span class="si">)</span>
<span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$TARGET_DIR</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0

<span class="c"># Unstage local files</span>
git reset HEAD <span class="nt">--</span> <span class="s2">"</span><span class="nv">$TARGET_DIR</span><span class="s2">/local/"</span> <span class="s2">"</span><span class="nv">$LOCAL_MANIFEST</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</code></pre></div></div> <p>This works with custom manifest names and target directories since it reads from the manifest itself.</p> <h2 id="mode-switching">Mode Switching</h2> <p>Users can switch between modes idempotently:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Switch to hook-based</span>
ai-rizz init <span class="nt">--local</span> <span class="nt">--hook-based-ignore</span>

<span class="c"># Switch back to regular</span>
ai-rizz init <span class="nt">--local</span>
</code></pre></div></div> <p>Switching from regular to hook-based removes <code class="language-plaintext highlighter-rouge">.git/info/exclude</code> entries and installs the hook. Switching back does the reverse.</p> <h2 id="the-trade-off">The Trade-off</h2> <p>Hook-based mode leaves a ‚Äúdirty‚Äù <code class="language-plaintext highlighter-rouge">git status</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git status
On branch main
Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)
        .cursor/rules/local/
        ai-rizz.local.skbd
</code></pre></div></div> <p>This may conflict with tooling that expects a clean status. But for Mac users whose Cursor can‚Äôt see local rules otherwise, it‚Äôs the only option until Cursor changes behavior.</p> <h2 id="implementation-details">Implementation Details</h2> <p>The hook preserves existing user hooks by wrapping the ai-rizz section in <code class="language-plaintext highlighter-rouge">BEGIN</code>/<code class="language-plaintext highlighter-rouge">END</code> markers. On deinit, only the ai-rizz section is removed.</p> <p>The <code class="language-plaintext highlighter-rouge">validate_git_exclude_state()</code> function now checks for hook presence before warning about missing git excludes - if the hook exists, files don‚Äôt need to be in <code class="language-plaintext highlighter-rouge">.git/info/exclude</code>.</p> <h2 id="usage">Usage</h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Initialize with hook-based mode</span>
ai-rizz init https://github.com/user/rules.git <span class="nt">--local</span> <span class="nt">--hook-based-ignore</span>

<span class="c"># Add rules as normal</span>
ai-rizz add rule my-rule.mdc <span class="nt">--local</span>

<span class="c"># Files remain visible to Cursor but won't be committed</span>
</code></pre></div></div> <p>The hook is harmless if files are already git-ignored (it becomes a no-op), so it could theoretically run in all local mode setups. For now, it‚Äôs opt-in via the flag.</p> </article> <footer> <p> tagged: <a href="/tags/ai-rizz/">ai-rizz</a>, <a href="/tags/cursor/">cursor</a>, <a href="/tags/git/">git</a>, <a href="/tags/pre-commit/">pre-commit</a>, <a href="/tags/tdd/">tdd</a> </p> </footer> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> </div> </main> </body> </html>
