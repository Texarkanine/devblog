<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Building My Second RubyGem</title>
<!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="Building My Second RubyGem"> <meta name="author" content="Niko"> <meta property="og:locale" content="en_US"> <meta name="description" content="Remember that first gem where I built styled cards for Jekyll? I tried adding automatic thumbnail generation to it. That failed architecturally. The solution became a second gem: jekyll-auto-thumbnails."> <meta property="og:description" content="Remember that first gem where I built styled cards for Jekyll? I tried adding automatic thumbnail generation to it. That failed architecturally. The solution became a second gem: jekyll-auto-thumbnails."> <link rel="canonical" href="https://blog.cani.ne.jp/2025/12/11/building-my-second-rubygem.html"> <meta property="og:url" content="https://blog.cani.ne.jp/2025/12/11/building-my-second-rubygem.html"> <meta property="og:site_name" content="ðŸ¶ Dog with a Dev Blog"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2025-12-11T00:00:00+00:00"> <meta name="twitter:card" content="summary"> <meta property="twitter:title" content="Building My Second RubyGem"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Niko"},"dateModified":"2025-12-11T00:00:00+00:00","datePublished":"2025-12-11T00:00:00+00:00","description":"Remember that first gem where I built styled cards for Jekyll? I tried adding automatic thumbnail generation to it. That failed architecturally. The solution became a second gem: jekyll-auto-thumbnails.","headline":"Building My Second RubyGem","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.cani.ne.jp/2025/12/11/building-my-second-rubygem.html"},"url":"https://blog.cani.ne.jp/2025/12/11/building-my-second-rubygem.html"}</script> <!-- End Jekyll SEO tag --> <link type="application/atom+xml" rel="alternate" href="https://blog.cani.ne.jp/feed.xml" title="ðŸ¶ Dog with a Dev Blog">
<link rel="shortcut icon" type="image/x-icon" href=""> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.css" integrity="sha384-OH8qNTHoMMVNVcKdKewlipV4SErXqccxxlg6HC9Cwjr5oZu2AdBej1TndeCirael" crossorigin="anonymous"> </head> <body a="light"> <main class="page-content" aria-label="Content"> <div class="w"> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> <header> <h1>Building My Second RubyGem</h1> <div style="display: flex; justify-content: space-between; align-items: center;"> <div> <span> a <a href="/categories/diary/">diary</a> </span> <span> by <a href="/authors/niko/">niko</a> </span> </div> <div> <span class="post-meta">2025-12-11</span> </div> </div> </header> <article> <p>Remember <a href="/2025/12/08/publishing-my-first-rubygem.html">that first gem</a> where I built styled cards for <a href="https://jekyllrb.com/" target="_blank" rel="noopener">Jekyll</a>? I tried adding automatic thumbnail generation to it. That failed architecturally. The solution became a second gem: <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails" target="_blank" rel="noopener">jekyll-auto-thumbnails</a>.</p> <h2 id="the-failed-first-attempt">The Failed First Attempt</h2> <p>The plan was simple: add thumbnail generation as a feature to <code class="language-plaintext highlighter-rouge">jekyll-highlight-cards</code>. Scan Markdown for sized images, generate thumbnails with MD5-based caching, replace URLs in the final HTML.</p> <p>I implemented it. 277 tests passing, 96% coverage. The feature worked in isolation.</p> <p>Then I tested it on this blog. Every image failed to generate thumbnails. The registry showed URLs like <code class="language-plaintext highlighter-rouge">/2025/11/25/photo.jpg</code>, but the actual files were at <code class="language-plaintext highlighter-rouge">/assets/img/blog/record/photo.jpg</code>.</p> <p>The problem: hook timing. My plugin ran in <code class="language-plaintext highlighter-rouge">:pre_render</code>, scanning raw Markdown. But <a href="https://github.com/Texarkanine/devblog/blob/a293c346612823fca18a6447902da688e57be247/_plugins/00_image_paths.rb" target="_blank" rel="noopener">image_paths.rb</a> (a local plugin) ran in <code class="language-plaintext highlighter-rouge">:post_render</code>, transforming <code class="language-plaintext highlighter-rouge">photo.jpg</code> into <code class="language-plaintext highlighter-rouge">/assets/img/blog/record/photo.jpg</code>. I was registering pre-transform URLs but trying to find post-transform files.</p> <h2 id="the-architecture-pivot">The Architecture Pivot</h2> <p>The fix wasnâ€™t to adjust hook timing. The fix was to realize <strong>image optimization is a separate concern</strong> from styled card presentation.</p> <p>New architecture: Scan the final rendered HTML after ALL plugins have run. Parse it with Nokogiri, look for <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> tags in <code class="language-plaintext highlighter-rouge">&lt;article&gt;</code> elements, extract the actual <code class="language-plaintext highlighter-rouge">src</code> attributes. Those URLs reflect reality - all transformations already applied.</p> <p>This required extracting the thumbnail feature into a standalone gem. The separation made sense: <a href="https://github.com/Texarkanine/jekyll-highlight-cards" target="_blank" rel="noopener">jekyll-highlight-cards</a> handles presentation (linkcard, polaroid tags). <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails" target="_blank" rel="noopener">jekyll-auto-thumbnails</a> handles optimization (thumbnail generation, caching, URL replacement).</p> <h2 id="building-the-second-gem">Building the Second Gem</h2> <p>I created <code class="language-plaintext highlighter-rouge">jekyll-auto-thumbnails</code> (initially named <code class="language-plaintext highlighter-rouge">jekyll-img-optimizer</code>, renamed before publish). Seven core modules following the same TDD approach:</p> <ol> <li>
<strong>Configuration</strong> - Parse <code class="language-plaintext highlighter-rouge">_config.yml</code> settings with validation</li> <li>
<strong>UrlResolver</strong> - Handle absolute/relative/external URLs</li> <li>
<strong>DigestCalculator</strong> - MD5 computation for cache keys</li> <li>
<strong>Registry</strong> - Track largest dimensions needed per image</li> <li>
<strong>Generator</strong> - ImageMagick integration for thumbnail creation</li> <li>
<strong>Scanner</strong> - HTML parsing to find images in <code class="language-plaintext highlighter-rouge">&lt;article&gt;</code> tags</li> <li>
<strong>Hooks</strong> - Jekyll integration via <code class="language-plaintext highlighter-rouge">:post_render</code> and <code class="language-plaintext highlighter-rouge">:post_write</code>
</li> </ol> <p>The key difference: Scanner operates on <strong>rendered HTML</strong>, not Markdown source.</p> <h2 id="the-dimension-merging-bug">The Dimension Merging Bug</h2> <p>First test on the blog revealed the generator was creating thumbnails at the <strong>smallest</strong> dimensions, not the largest.</p> <p>A polaroid at <code class="language-plaintext highlighter-rouge">size=x400</code> (height 400, width auto) and a Markdown image at <code class="language-plaintext highlighter-rouge">=200x</code> (width 200, height auto) both referenced the same image. The registry merged these as:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="ss">width: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">height: </span><span class="mi">400</span> <span class="p">}</span>  <span class="c1"># Wrong - takes the ONLY non-nil value for each</span>
</code></pre></div></div> <p>This produced a 200x400 thumbnail. When displayed at ~500px width, it looked terrible - upscaled 2.5x from a thumbnail that should have been 536x400.</p> <p>The fix: <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails/blob/v0.2.1/lib/jekyll-auto-thumbnails/scanner.rb#L104-L113" target="_blank" rel="noopener">Scanner calculates missing dimensions</a> from aspect ratio before registering. Query ImageMagick for actual image dimensions, compute the missing value, then register complete dimensions.</p> <p>Now <code class="language-plaintext highlighter-rouge">size=x400</code> registers as <code class="language-plaintext highlighter-rouge">{ width: 536, height: 400 }</code> (calculated from 1.34:1 aspect ratio), and the Registry correctly chooses 536x400 as the maximum.</p> <h2 id="the-animated-gif-bug">The Animated GIF Bug</h2> <p>An image named <code class="language-plaintext highlighter-rouge">dogblog-468x60.gif</code> generated a thumbnail named <code class="language-plaintext highlighter-rouge">dogblog-468x60_thumb-bb988d-46x60.gif</code>. The width lost an <code class="language-plaintext highlighter-rouge">8</code>.</p> <p>The GIF was animated (25 frames). ImageMagickâ€™s <code class="language-plaintext highlighter-rouge">identify</code> command returned dimensions for <strong>all frames concatenated</strong>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>468x605x511x1014x1420x19391x23394x25398x27399x2724x2325x2428x27
</code></pre></div></div> <p>My code split on <code class="language-plaintext highlighter-rouge">x</code> and took the first two values: <code class="language-plaintext highlighter-rouge">468</code> and <code class="language-plaintext highlighter-rouge">605</code>. The <code class="language-plaintext highlighter-rouge">605</code> was frame 1â€™s height (60) plus the start of frame 2â€™s dimensions (5). This gave the wrong aspect ratio.</p> <p>The fix: <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails/blob/v0.2.1/lib/jekyll-auto-thumbnails/scanner.rb#L81" target="_blank" rel="noopener">Query only the first frame</a> with <code class="language-plaintext highlighter-rouge">identify "#{file_path}[0]"</code>. The <code class="language-plaintext highlighter-rouge">[0]</code> index tells ImageMagick to return dimensions for frame zero only.</p> <p>Test with actual animated GIF confirmed: <code class="language-plaintext highlighter-rouge">468x60</code> parsed correctly.</p> <h2 id="coderabbits-security-review">CodeRabbitâ€™s Security Review</h2> <p>After the initial implementation, CodeRabbit flagged five issues. All five were valid.</p> <p><strong>Issue 1: Unix-only ImageMagick detection</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">system</span><span class="p">(</span><span class="s2">"which convert &gt; /dev/null 2&gt;&amp;1"</span><span class="p">)</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">which</code> command doesnâ€™t exist on Windows. <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails/blob/v0.2.1/lib/jekyll-auto-thumbnails/generator.rb#L19-L26" target="_blank" rel="noopener">Fixed by searching ENV[â€˜PATHâ€™]</a> manually:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">imagemagick_available?</span>
  <span class="n">cmd_name</span> <span class="o">=</span> <span class="no">Gem</span><span class="p">.</span><span class="nf">win_platform?</span> <span class="p">?</span> <span class="s2">"convert.exe"</span> <span class="p">:</span> <span class="s2">"convert"</span>
  <span class="n">path_dirs</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"PATH"</span><span class="p">].</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="no">File</span><span class="o">::</span><span class="no">PATH_SEPARATOR</span><span class="p">)</span>
  
  <span class="n">path_dirs</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">executable?</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">cmd_name</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong>Issue 2 &amp; 3: Shell command injection</strong></p> <p>Two methods used string-based <code class="language-plaintext highlighter-rouge">system()</code> calls and backticks, both invoking a shell:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_parts</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
<span class="nb">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  <span class="c1"># Shell interprets special characters</span>

<span class="n">output</span> <span class="o">=</span> <span class="sb">`identify ... </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="sb">[0] 2&gt;/dev/null`</span>  <span class="c1"># Shell interprets</span>
</code></pre></div></div> <p><a href="https://github.com/Texarkanine/jekyll-auto-thumbnails/blob/v0.2.1/lib/jekyll-auto-thumbnails/generator.rb#L98-L109" target="_blank" rel="noopener">Fixed by using array-based execution</a>:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">system</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="s2">"convert"</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="s2">"-resize"</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="s2">"-quality"</span><span class="p">,</span> <span class="s2">"85"</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">])</span>

<span class="n">output</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="no">Open3</span><span class="p">.</span><span class="nf">capture2e</span><span class="p">(</span><span class="s2">"identify"</span><span class="p">,</span> <span class="s2">"-format"</span><span class="p">,</span> <span class="s2">"%wx%h"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">[0]"</span><span class="p">)</span>
</code></pre></div></div> <p>No shell invocation, no special character interpretation, works on both Unix and Windows.</p> <p><strong>Issue 4: File.join for URLs</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">thumb_url</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">url_dir</span><span class="p">,</span> <span class="n">thumb_filename</span><span class="p">)</span>  <span class="c1"># Uses OS-specific separators</span>
</code></pre></div></div> <p>On Windows, <code class="language-plaintext highlighter-rouge">File.join</code> produces backslashes. URLs must always use forward slashes. Fixed with explicit string concatenation:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">thumb_url</span> <span class="o">=</span> <span class="k">if</span> <span class="n">url_dir</span> <span class="o">==</span> <span class="s2">"."</span>
              <span class="s2">"/</span><span class="si">#{</span><span class="n">thumb_filename</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">else</span>
              <span class="s2">"</span><span class="si">#{</span><span class="n">url_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">thumb_filename</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">end</span>
</code></pre></div></div> <p><strong>Issue 5: HTML structure concerns</strong></p> <p>CodeRabbit suggested <code class="language-plaintext highlighter-rouge">Nokogiri::HTML()</code> might corrupt document structure. Assessed as non-issue - Jekyllâ€™s <code class="language-plaintext highlighter-rouge">doc.output</code> is already complete HTML, parsing and re-serializing doesnâ€™t cause problems. Added early return for performance but no structural changes needed.</p> <h2 id="two-critical-sanity-checks">Two Critical Sanity Checks</h2> <p>After CodeRabbitâ€™s review, I added two optimizations:</p> <p><strong>Check 1: Skip if dimensions match original</strong></p> <p>If an image is 300x200 and you request a 300x200 thumbnail, donâ€™t generate anything. Use the original.</p> <p><strong>Check 2: Delete if thumbnail larger than source</strong></p> <p>Sometimes compression doesnâ€™t help. A small, highly compressed image might produce a larger thumbnail if thumbnailing is configured at high quality. If <code class="language-plaintext highlighter-rouge">File.size(thumbnail) &gt; File.size(original)</code>, <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails/blob/v0.2.1/lib/jekyll-auto-thumbnails/generator.rb#L59-L66" target="_blank" rel="noopener">delete the thumbnail</a> and use the original.</p> <p>Testing on this blog: 13 images detected, 6 rejected (thumbnail would be larger), 7 optimized. The plugin only optimizes when beneficial.</p> <h2 id="examples-in-action">Examples in Action</h2> <p>The gem is running on this blog right now. That polaroid from the previous post:</p> <div class="polaroid-container"> <div class="polaroid"> <a href="/assets/img/blog/record/gemini-trip-to-japan.jpg" target="_blank" rel="noopener"> <img src="/assets/img/blog/record/gemini-trip-to-japan_thumb-45be04-536x400.jpg" alt="Trip to Japan (with automatic thumbnail)" height="400" class="polaroid-image" loading="lazy"> </a> <div class="polaroid-title">Trip to Japan (with automatic thumbnail)</div> <div class="polaroid-link"> <a href="https://www.japan.go.jp/japan/visit/index.html" target="_blank" rel="noopener">www.japan.go.jp/japan/visit/index.html</a> </div> <small class="polaroid-archive"> Â  </small> </div> </div> <p>The original image is 818KB. The thumbnail served is 115KB (86% reduction). The plugin calculated the correct width (536px) from the 400px height constraint and the imageâ€™s aspect ratio, generated <code class="language-plaintext highlighter-rouge">gemini-trip-to-japan_thumb-45be04-536x400.jpg</code> in <code class="language-plaintext highlighter-rouge">.jekyll-cache/</code>, copied it to <code class="language-plaintext highlighter-rouge">_site/</code>, and replaced the URL in the HTML.</p> <p>The same image used elsewhere at a different size would share that thumbnail if the dimensions are smaller, or trigger a larger thumbnail generation if bigger. Like this:</p> <p><a href="/assets/img/blog/record/gemini-trip-to-japan.jpg" target="_blank" rel="noopener"><img width="200" src="/assets/img/blog/record/gemini-trip-to-japan_thumb-45be04-536x400.jpg" alt="Trip to Japan" loading="lazy"></a></p> <h2 id="final-stats">Final Stats</h2> <ul> <li><strong>58 tests, all passing</strong></li> <li><strong>90.0% code coverage</strong></li> <li>
<strong>20 commits</strong> from extraction to production</li> <li>
<strong>Published to RubyGems:</strong> <a href="https://rubygems.org/gems/jekyll-auto-thumbnails" target="_blank" rel="noopener">jekyll-auto-thumbnails</a>
</li> <li>
<strong>Installation:</strong> <code class="language-plaintext highlighter-rouge">gem install jekyll-auto-thumbnails</code>
</li> </ul> <p>The gem scans rendered HTML for images in <code class="language-plaintext highlighter-rouge">&lt;article&gt;</code> tags, generates thumbnails with MD5-based caching, and replaces URLs transparently. Works with any Jekyll plugins that transform image paths because it runs after all rendering completes.</p> <h2 id="what-i-learned">What I Learned</h2> <p><strong>Jekyll hook timing determines what you see.</strong> Pre-render hooks see Markdown and Liquid. Post-render hooks see final HTML. If other plugins transform content, you need to run after them.</p> <p><strong>Scanning rendered HTML instead of source is plugin-agnostic.</strong> Any URL-transforming plugin works because youâ€™re reading the end result, not guessing at transformations.</p> <p><strong>ImageMagickâ€™s identify returns all frames for animated GIFs.</strong> Use <code class="language-plaintext highlighter-rouge">[0]</code> to get first frame only: <code class="language-plaintext highlighter-rouge">identify "file.gif[0]"</code>. Without it, parsing <code class="language-plaintext highlighter-rouge">468x605x51...</code> gives wrong dimensions.</p> <p><strong>Backticks and string-based system() invoke shells.</strong> Even with <code class="language-plaintext highlighter-rouge">Shellwords.escape</code>. Use <code class="language-plaintext highlighter-rouge">system(*array)</code> or <code class="language-plaintext highlighter-rouge">Open3.capture2e</code> for shell-free execution. Safer and cross-platform.</p> <p><strong>File.join uses OS-specific separators.</strong> URLs need forward slashes always, but <code class="language-plaintext highlighter-rouge">File.join</code> produces backslashes on Windows. Build URLs with string concatenation, not path operations.</p> <p><strong>Sometimes thumbnails are larger than originals.</strong> Small, compressed images might expand when reprocessed. Check file size after generation and delete if larger.</p> <p><strong>Separation of concerns can emerge from failed integration.</strong> The thumbnail feature didnâ€™t belong in a styled-cards gem. The architecture problem revealed the right boundaries.</p> <h2 id="the-repository">The Repository</h2> <p>The code is at <a href="https://github.com/Texarkanine/jekyll-auto-thumbnails" target="_blank" rel="noopener">Texarkanine/jekyll-auto-thumbnails</a> with the full implementation history.</p> <p>Two gems now: one for presentation, one for optimization. Both do their jobs without interfering with each other or with other Jekyll plugins.</p> </article> <footer> <p> tagged: <a href="/tags/imagemagick/">imagemagick</a>, <a href="/tags/jekyll/">jekyll</a>, <a href="/tags/ruby/">ruby</a>, <a href="/tags/rubygem/">rubygem</a> </p> </footer> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> </div> </main> </body> </html>
