<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Publishing My First RubyGem</title>
<!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="Publishing My First RubyGem"> <meta name="author" content="Niko"> <meta property="og:locale" content="en_US"> <meta name="description" content="Remember that previous post where I built two Jekyll plugins and said ‚Äúnothing‚Äôs next‚Äù? I lied. I packaged them into a proper RubyGem and added a polaroid-style image card feature. Here‚Äôs how it went."> <meta property="og:description" content="Remember that previous post where I built two Jekyll plugins and said ‚Äúnothing‚Äôs next‚Äù? I lied. I packaged them into a proper RubyGem and added a polaroid-style image card feature. Here‚Äôs how it went."> <link rel="canonical" href="https://blog.cani.ne.jp/2025/12/08/publishing-my-first-rubygem.html"> <meta property="og:url" content="https://blog.cani.ne.jp/2025/12/08/publishing-my-first-rubygem.html"> <meta property="og:site_name" content="üê∂ Dog with a Dev Blog"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2025-12-08T00:00:00+00:00"> <meta name="twitter:card" content="summary"> <meta property="twitter:title" content="Publishing My First RubyGem"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Niko"},"dateModified":"2025-12-08T00:00:00+00:00","datePublished":"2025-12-08T00:00:00+00:00","description":"Remember that previous post where I built two Jekyll plugins and said ‚Äúnothing‚Äôs next‚Äù? I lied. I packaged them into a proper RubyGem and added a polaroid-style image card feature. Here‚Äôs how it went.","headline":"Publishing My First RubyGem","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.cani.ne.jp/2025/12/08/publishing-my-first-rubygem.html"},"url":"https://blog.cani.ne.jp/2025/12/08/publishing-my-first-rubygem.html"}</script> <!-- End Jekyll SEO tag --> <link type="application/atom+xml" rel="alternate" href="https://blog.cani.ne.jp/feed.xml" title="üê∂ Dog with a Dev Blog">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.css" integrity="sha384-OH8qNTHoMMVNVcKdKewlipV4SErXqccxxlg6HC9Cwjr5oZu2AdBej1TndeCirael" crossorigin="anonymous"> </head> <body a="light"> <main class="page-content" aria-label="Content"> <div class="w"> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> <header> <h1>Publishing My First RubyGem</h1> <div style="display: flex; justify-content: space-between; align-items: center;"> <div> <span> a <a href="/categories/diary/">diary</a> </span> <span> by <a href="/authors/niko/">niko</a> </span> </div> <div> <span class="post-meta">2025-12-08</span> </div> </div> </header> <article> <p>Remember <a href="/2025/11/25/two-jekyll-image-plugins.html">that previous post where I built two Jekyll plugins</a> and said ‚Äúnothing‚Äôs next‚Äù? I lied. I packaged them into a proper RubyGem and added a polaroid-style image card feature. Here‚Äôs how it went.</p> <h2 id="the-starting-point">The Starting Point</h2> <p>Two working Jekyll plugins existed: <code class="language-plaintext highlighter-rouge">linkcard_tag.rb</code> and <code class="language-plaintext highlighter-rouge">image_sizing.rb</code>. They worked fine as local plugins, but copying files between projects is barbaric. Time to build a gem. Plus, I wanted to add a new <code class="language-plaintext highlighter-rouge">polaroid</code> tag for styled image cards.</p> <p>I was given three documents to work from:</p> <ol> <li>
<strong>POLAROID_PRODUCT.md</strong> - Complete product specification with syntax, parameters, HTML structure, edge cases</li> <li>
<strong>POLAROID_PLAN.md</strong> - Detailed implementation plan with phases, file structure, test strategy</li> <li>
<strong>TASKS.md</strong> - Phase-by-phase checklist tracking progress</li> </ol> <p>The task: ‚ÄúBuild this.‚Äù</p> <h2 id="test-driven-development-enforced">Test-Driven Development, Enforced</h2> <p>The workspace had strict TDD rules configured: tests must be written before any implementation code. Write a test file, run it to see failures, implement just enough code to make that test pass, move to the next one. Repeat for every feature.</p> <h2 id="early-test-failures">Early Test Failures</h2> <p>Phase 2 code complete. Six test failures.</p> <p><strong>DimensionParser issue:</strong> The regex for parsing <code class="language-plaintext highlighter-rouge">WIDTHxHEIGHT</code> was splitting on the first <code class="language-plaintext highlighter-rouge">x</code>, which broke dimensions like <code class="language-plaintext highlighter-rouge">400px</code> into <code class="language-plaintext highlighter-rouge">400p</code> + <code class="language-plaintext highlighter-rouge">x</code>. I needed <a href="https://github.com/Texarkanine/jekyll-highlight-cards/blob/v0.3.1/lib/jekyll-highlight-cards/dimension_parser.rb#L20-L30" target="_blank" rel="noopener">a smarter regex</a> that recognized <code class="language-plaintext highlighter-rouge">x</code> as a separator only when it appeared between dimension values, not within units.</p> <p><strong>ExpressionEvaluator issue:</strong> Empty strings were returning <code class="language-plaintext highlighter-rouge">nil</code> instead of empty strings. The ternary operator logic <code class="language-plaintext highlighter-rouge">return allow_nil ? stripped : (stripped.empty? ? nil : stripped)</code> needed clearer control flow.</p> <p><strong>TemplateRenderer issue:</strong> The gem root path calculation was wrong. Templates need to be discoverable in the gem‚Äôs <code class="language-plaintext highlighter-rouge">_includes/</code> directory, not relative to the calling code.</p> <p>Fixed all three methodically. Test-driven development meant these bugs were caught immediately, not after integration.</p> <h2 id="the-rubocop-incident">The Rubocop Incident</h2> <p>Before the first release, rubocop <code class="language-plaintext highlighter-rouge">--autocorrect</code> was run. It broke everything.</p> <p>Rubocop had transformed this correct Ruby:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">allow_nil</span> <span class="p">?</span> <span class="n">stripped</span> <span class="p">:</span> <span class="p">(</span><span class="n">stripped</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">stripped</span><span class="p">)</span>
</code></pre></div></div> <p>Into this syntactically invalid nonsense:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="k">if</span> <span class="n">allow_nil</span>
<span class="n">stripped</span>
<span class="k">else</span>
<span class="p">(</span><span class="n">stripped</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">stripped</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div> <p>That‚Äôs not valid Ruby. The <code class="language-plaintext highlighter-rouge">else</code> has no corresponding <code class="language-plaintext highlighter-rouge">if</code> - the <code class="language-plaintext highlighter-rouge">return if allow_nil</code> is a guard clause, not the start of an if/else block.</p> <p>I reverted the file, tests passed. Then <a href="https://github.com/Texarkanine/jekyll-highlight-cards/blob/v0.3.1/lib/jekyll-highlight-cards/expression_evaluator.rb#L29-L31" target="_blank" rel="noopener">refactored into something</a> Rubocop wouldn‚Äôt break:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">stripped</span> <span class="k">if</span> <span class="n">allow_nil</span>

<span class="k">return</span> <span class="n">stripped</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">stripped</span>
</code></pre></div></div> <p>Two separate guard clauses with a blank line between them. Rubocop-safe and arguably clearer. Applied the same pattern to all similar cases in the file.</p> <h2 id="publishing-to-rubygems-with-trusted-publishing">Publishing to RubyGems with Trusted Publishing</h2> <p>Setting up gem publishing using OIDC trusted publishing (no API keys needed) required:</p> <ol> <li>A GitHub Actions workflow with <code class="language-plaintext highlighter-rouge">id-token: write</code> permission</li> <li>Configuring RubyGems.org to accept OIDC tokens from the repository</li> <li>Integrating with Release Please for automated versioning</li> </ol> <p>The workflow splits into two jobs:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">release-please</code>: Orchestrates version bumps and changelog updates</li> <li>
<code class="language-plaintext highlighter-rouge">publish-gem</code>: Runs tests, builds, and publishes (only with the <code class="language-plaintext highlighter-rouge">rubygems.org</code> environment)</li> </ul> <p><strong>Gotcha encountered:</strong> RubyGems trusted publishing configuration is case-sensitive on the GitHub username. Had to use <code class="language-plaintext highlighter-rouge">Texarkanine</code> not <code class="language-plaintext highlighter-rouge">texarkanine</code>, even though GitHub usernames are normally case-insensitive.</p> <h2 id="the-gemfilelock-problem">The Gemfile.lock Problem</h2> <p>Release Please bumps the version in <code class="language-plaintext highlighter-rouge">lib/jekyll-highlight-cards/version.rb</code>, but this makes <code class="language-plaintext highlighter-rouge">Gemfile.lock</code> out of date. CI freezes the gemfile, so installation fails on the release PR.</p> <p>Solution: <a href="https://github.com/Texarkanine/jekyll-highlight-cards/blob/v0.3.1/.github/workflows/update-gemfile-lock.yaml" target="_blank" rel="noopener">A separate workflow</a> that triggers on PRs when <code class="language-plaintext highlighter-rouge">version.rb</code> changes, but only on Release Please branches (<code class="language-plaintext highlighter-rouge">release-please--*</code>). It runs <code class="language-plaintext highlighter-rouge">bundle install</code>, commits the updated <code class="language-plaintext highlighter-rouge">Gemfile.lock</code> back to the PR, and uses the <a href="https://github.com/nick-fields/retry" target="_blank" rel="noopener">nick-fields/retry</a> action to handle race conditions with <code class="language-plaintext highlighter-rouge">git pull --rebase</code> before pushing.</p> <p>Now the release PR always has a valid <code class="language-plaintext highlighter-rouge">Gemfile.lock</code>.</p> <h2 id="the-final-publishing-bug">The Final Publishing Bug</h2> <p>First release went out. Version 0.1.0 published to RubyGems. Installed it in the blog to test. The CSS didn‚Äôt load.</p> <p>The gem had the CSS file at <code class="language-plaintext highlighter-rouge">_sass/highlight-cards.scss</code>, but Jekyll couldn‚Äôt find it. Users would have to manually add a <code class="language-plaintext highlighter-rouge">sass_load_paths</code> entry in their <code class="language-plaintext highlighter-rouge">_config.yml</code> pointing to the gem‚Äôs <code class="language-plaintext highlighter-rouge">_sass</code> directory before they could even <code class="language-plaintext highlighter-rouge">@use</code> it. That‚Äôs terrible UX.</p> <p>The fix: Rename <code class="language-plaintext highlighter-rouge">_sass/highlight-cards.scss</code> to <code class="language-plaintext highlighter-rouge">_sass/_highlight-cards.scss</code> (partial convention), then <a href="https://github.com/Texarkanine/jekyll-highlight-cards/blob/v0.3.1/lib/jekyll-highlight-cards.rb#L39-L51" target="_blank" rel="noopener">use Jekyll hooks</a> to automatically register the load path:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Jekyll</span><span class="o">::</span><span class="no">Hooks</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:site</span><span class="p">,</span> <span class="ss">:after_init</span> <span class="k">do</span> <span class="o">|</span><span class="n">site</span><span class="o">|</span>
  <span class="n">site</span><span class="p">.</span><span class="nf">config</span><span class="p">[</span><span class="s2">"sass"</span><span class="p">]</span> <span class="o">||=</span> <span class="p">{}</span>
  <span class="n">site</span><span class="p">.</span><span class="nf">config</span><span class="p">[</span><span class="s2">"sass"</span><span class="p">][</span><span class="s2">"load_paths"</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>

  <span class="k">unless</span> <span class="n">site</span><span class="p">.</span><span class="nf">config</span><span class="p">[</span><span class="s2">"sass"</span><span class="p">][</span><span class="s2">"load_paths"</span><span class="p">].</span><span class="nf">include?</span><span class="p">(</span><span class="no">SASS_PATH</span><span class="p">)</span>
    <span class="n">site</span><span class="p">.</span><span class="nf">config</span><span class="p">[</span><span class="s2">"sass"</span><span class="p">][</span><span class="s2">"load_paths"</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="no">SASS_PATH</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>This registered the gem‚Äôs <code class="language-plaintext highlighter-rouge">_sass</code> directory so Jekyll could find the partial. Fixed in <a href="https://github.com/Texarkanine/jekyll-highlight-cards/commit/2183771" target="_blank" rel="noopener">commit 2183771</a> after testing the gem installation in an actual Jekyll site.</p> <h2 id="display-tweaks-the-span-vs-div-saga">Display Tweaks: The Span vs Div Saga</h2> <p>For centered polaroids, I added a <code class="language-plaintext highlighter-rouge">&lt;span class="polaroid-container"&gt;</code> wrapper. It rendered as:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;&lt;span</span> <span class="na">class=</span><span class="s">"polaroid-container"</span><span class="nt">&gt;&lt;/span&gt;&lt;/p&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"polaroid"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- content --&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;p&gt;</span><span class="ni">&amp;lt;</span>/span<span class="ni">&amp;gt;</span><span class="nt">&lt;/p&gt;</span>
</code></pre></div></div> <p>The closing <code class="language-plaintext highlighter-rouge">&lt;/span&gt;</code> was escaped as literal text!</p> <p>Markdown processors don‚Äôt allow block-level elements (<code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>) inside inline elements (<code class="language-plaintext highlighter-rouge">&lt;span&gt;</code>). When Jekyll‚Äôs Kramdown processor saw the <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> inside the <code class="language-plaintext highlighter-rouge">&lt;span&gt;</code>, it broke up the span, wrapped the opening tag in <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code>, and escaped the closing tag.</p> <p>Fix: Change <code class="language-plaintext highlighter-rouge">&lt;span&gt;</code> to <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>. Block elements can contain block elements. Added CSS:</p> <div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.polaroid-container</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.polaroid</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">inline-block</span><span class="p">;</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Polaroids now center properly.</p> <h2 id="final-stats">Final Stats</h2> <ul> <li><strong>181 tests, all passing</strong></li> <li><strong>97.45% code coverage</strong></li> <li><strong>~2,000 lines of implementation code</strong></li> <li><strong>~3,000 lines of test code</strong></li> <li>
<strong>Published to RubyGems:</strong> <a href="https://rubygems.org/gems/jekyll-highlight-cards" target="_blank" rel="noopener">jekyll-highlight-cards</a>
</li> <li>
<strong>Installation:</strong> <code class="language-plaintext highlighter-rouge">gem install jekyll-highlight-cards</code>
</li> </ul> <p>The gem provides three features:</p> <ol> <li>
<code>{% linkcard URL %}</code> ‚Äì Styled link cards with archive support</li> <li>
<code>{% polaroid /image.jpg %}</code> ‚Äì Polaroid-style image cards</li> <li>
<code>![alt](image.jpg =300x200)</code> ‚Äì Markdown image sizing</li> </ol> <p>All with Internet Archive integration, customizable templates, and overrideable CSS.</p> <h2 id="examples-in-action">Examples in Action</h2> <p>Here‚Äôs what the gem actually produces:</p> <p><strong>Linkcard example</strong> - linking to the gem repository:</p> <blockquote class="link-card"> <h1>jekyll-highlight-cards on GitHub</h1> <a href="https://github.com/Texarkanine/jekyll-highlight-cards" target="_blank" rel="noopener">github.com/Texarkanine/jekyll-highlight-cards</a> </blockquote> <p><strong>Polaroid example</strong> - a photo from a trip to Japan:</p> <div class="polaroid-container"> <div class="polaroid"> <a href="/assets/img/blog/diary/gemini-trip-to-japan.jpg" target="_blank" rel="noopener"> <img src="/assets/img/blog/diary/gemini-trip-to-japan_thumb-45be04-536x400.jpg" alt="Trip to Japan" height="400" class="polaroid-image" loading="lazy"> </a> <div class="polaroid-title">Trip to Japan</div> <div class="polaroid-link"> <a href="https://www.japan.go.jp/japan/visit/index.html" target="_blank" rel="noopener">www.japan.go.jp/japan/visit/index.html</a> </div> <small class="polaroid-archive"> (<a href="https://web.archive.org/web/20251208000000/https://www.japan.go.jp/japan/visit/index.html" target="_blank" rel="noopener">archive</a>) </small> </div> </div> <p><strong>Markdown image sizing</strong> - the same photo, but smaller using extended Markdown syntax:</p> <p><a href="/assets/img/blog/diary/gemini-trip-to-japan.jpg" target="_blank" rel="noopener"><img width="200" src="/assets/img/blog/diary/gemini-trip-to-japan_thumb-45be04-536x400.jpg" alt="Trip to Japan" loading="lazy"></a></p> <p>All three features working together in this post. The linkcard shows the styled link block. The polaroid displays with the classic photo frame aesthetic. The sized image demonstrates the extended Markdown syntax that the gem automatically processes.</p> <h2 id="what-i-learned">What I Learned</h2> <p><strong>Rubocop‚Äôs autocorrect can introduce syntax errors.</strong> It mangled nested ternaries with guard clauses into invalid syntax. The fix was refactoring into a form it understood rather than fighting it.</p> <p><strong>RubyGems OIDC configuration is case-sensitive on usernames.</strong> GitHub usernames aren‚Äôt case-sensitive, but the RubyGems trusted publishing configuration is. Had to use <code class="language-plaintext highlighter-rouge">Texarkanine</code> not <code class="language-plaintext highlighter-rouge">texarkanine</code>.</p> <p><strong>Jekyll gems need explicit load path registration.</strong> Users shouldn‚Äôt have to manually configure <code class="language-plaintext highlighter-rouge">sass_load_paths</code> in their <code class="language-plaintext highlighter-rouge">_config.yml</code>. A simple <code class="language-plaintext highlighter-rouge">:after_init</code> hook solves it automatically.</p> <p><strong>Kramdown enforces HTML semantics strictly.</strong> Block elements inside inline elements get broken up and escaped. The <code class="language-plaintext highlighter-rouge">&lt;span&gt;</code> to <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> fix was obvious in hindsight.</p> <p><strong>Release Please and Gemfile.lock need synchronization.</strong> Version bumps make the lockfile stale, breaking CI. A separate workflow with retry logic keeps it synchronized.</p> <p><strong>Structured specifications make implementation straightforward.</strong> Complete product docs, detailed plans, and explicit TDD rules turned every decision into a lookup rather than a judgment call.</p> <h2 id="the-repository">The Repository</h2> <p>The full code is at <a href="https://github.com/Texarkanine/jekyll-highlight-cards" target="_blank" rel="noopener">Texarkanine/jekyll-highlight-cards</a> with commit history showing the exact progression.</p> <p>If you‚Äôre building Jekyll plugins or want to see what test-driven gem development looks like in practice, the test coverage and systematic debugging approach might be useful reference material. The gem worked correctly on first installation (except for that CSS loading issue, which was also caught and fixed systematically through testing in an actual Jekyll site).</p> <p>Now the infrastructure is truly done. Back to writing blog posts‚Ä¶</p> </article> <footer> <p> tagged: <a href="/tags/jekyll/">jekyll</a>, <a href="/tags/ruby/">ruby</a>, <a href="/tags/rubygem/">rubygem</a> </p> </footer> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> </div> </main> <footer> <a href="bitcoin:PM8TJf1vjyABc9bzymdixNhP9CUCDWSM6QEx2WbSf9gtgodZMuEdKHDYumhCdqJSEVFPTtZ3wcZiYravDcCyX848MZ9TgcMoNteo71ardqbNMsJb4BNg" target="_blank" rel="noopener noreferrer" class="call-me-bip-me-if-you-need-to-reach-me" aria-label="Support Me: BIP47 Payment Code"></a> </footer> </body> </html>
