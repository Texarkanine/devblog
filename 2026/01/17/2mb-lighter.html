<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>2MB Lighter</title>
<!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="2MB Lighter"> <meta name="author" content="Niko"> <meta property="og:locale" content="en_US"> <meta name="description" content="The mermaid.js chart library weighs in at ~2MB minified. I wanted diagrams in my blog posts, but not at that cost. The solution became my third Jekyll gem: jekyll-mermaid-prebuild."> <meta property="og:description" content="The mermaid.js chart library weighs in at ~2MB minified. I wanted diagrams in my blog posts, but not at that cost. The solution became my third Jekyll gem: jekyll-mermaid-prebuild."> <link rel="canonical" href="https://blog.cani.ne.jp/2026/01/17/2mb-lighter.html"> <meta property="og:url" content="https://blog.cani.ne.jp/2026/01/17/2mb-lighter.html"> <meta property="og:site_name" content="ðŸ¶ Dog with a Dev Blog"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2026-01-17T00:00:00+00:00"> <meta name="twitter:card" content="summary"> <meta property="twitter:title" content="2MB Lighter"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Niko"},"dateModified":"2026-01-17T00:00:00+00:00","datePublished":"2026-01-17T00:00:00+00:00","description":"The mermaid.js chart library weighs in at ~2MB minified. I wanted diagrams in my blog posts, but not at that cost. The solution became my third Jekyll gem: jekyll-mermaid-prebuild.","headline":"2MB Lighter","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.cani.ne.jp/2026/01/17/2mb-lighter.html"},"url":"https://blog.cani.ne.jp/2026/01/17/2mb-lighter.html"}</script> <!-- End Jekyll SEO tag --> <link type="application/atom+xml" rel="alternate" href="https://blog.cani.ne.jp/feed.xml" title="ðŸ¶ Dog with a Dev Blog">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.css" integrity="sha384-OH8qNTHoMMVNVcKdKewlipV4SErXqccxxlg6HC9Cwjr5oZu2AdBej1TndeCirael" crossorigin="anonymous"> </head> <body a="light"> <main class="page-content" aria-label="Content"> <div class="w"> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> <header> <h1>2MB Lighter</h1> <strong>Building my third Jekyll gem</strong> <div style="display: flex; justify-content: space-between; align-items: center;"> <div> <span> a <a href="/categories/diary/">diary</a> </span> <span> by <a href="/authors/niko/">niko</a> </span> </div> <div> <span class="post-meta">2026-01-17</span> </div> </div> </header> <article> <p>The <a href="https://mermaid.js.org/" target="_blank" rel="noopener">mermaid.js chart library</a> weighs in at ~2MB minified. I wanted diagrams in my blog posts, but not at that cost. The solution became my third Jekyll gem: <a href="https://rubygems.org/gems/jekyll-mermaid-prebuild" target="_blank" rel="noopener">jekyll-mermaid-prebuild</a>.</p> <h2 id="the-setup">The Setup</h2> <p>I had a <a href="/2026/01/17/all-it-took-was-broken-firmware.html">blog post with several Mermaid diagrams explaining a firmware debugging story</a>. The standard approach - include mermaid.js and let it render client-side - would add 2MB to every page load. For static diagrams that never change after publishing, thatâ€™s absurd.</p> <p>The mermaid project provides <code class="language-plaintext highlighter-rouge">mmdc</code>, a <a href="https://github.com/mermaid-js/mermaid-cli" target="_blank" rel="noopener">CLI that renders diagrams to SVG using headless Chrome</a>. A Jekyll plugin could intercept mermaid code blocks during build, shell out to <code class="language-plaintext highlighter-rouge">mmdc</code>, and replace them with static SVG references. No client-side JavaScript needed.</p> <h2 id="prototype-in-_plugins">Prototype in <code class="language-plaintext highlighter-rouge">_plugins/</code>
</h2> <p>Following the pattern from <a href="/2025/12/11/building-my-second-rubygem.html">jekyll-auto-thumbnails</a>, I started with a local plugin before extracting to a gem. Faster iteration, immediate feedback.</p> <p>The first attempt operated on rendered HTML, scanning for <code class="language-plaintext highlighter-rouge">&lt;code class="language-mermaid"&gt;</code> blocks. This worked, but produced inline SVG data URIs - ugly in the output and not separately cacheable.</p> <p>Better approach: operate on <strong>markdown</strong> during <code class="language-plaintext highlighter-rouge">:pre_render</code>. Find mermaid code blocks, convert to SVG files, replace with image references. The SVGs become proper static assets - cacheable by browsers, clickable for full-size viewing.</p> <h2 id="puppeteer-in-wsl">Puppeteer in WSL</h2> <p>First test run:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MermaidPrebuild: Initialized (mmdc 11.12.0)
MermaidPrebuild: mmdc failed: error while loading shared libraries: libgbm.so.1
</code></pre></div></div> <p>The mermaid CLI uses Puppeteer (headless Chrome) internally. WSL - my local build environment - doesnâ€™t ship with Chromeâ€™s system library dependencies.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libgbm1 libasound2 libatk1.0-0 <span class="se">\</span>
  libatk-bridge2.0-0 libcups2 libdrm2 libxcomposite1 <span class="se">\</span>
  libxdamage1 libxfixes3 libxrandr2 libxkbcommon0 <span class="se">\</span>
  libpango-1.0-0 libcairo2 libnss3 libnspr4
</code></pre></div></div> <p>After installing the dependencies, <code class="language-plaintext highlighter-rouge">mmdc</code> worked. The plugin <a href="https://github.com/Texarkanine/jekyll-mermaid-prebuild/blob/v0.2.0/lib/jekyll-mermaid-prebuild/hooks.rb#L36-L51" target="_blank" rel="noopener">detects this failure mode</a> and prints the apt-get command in the error message.</p> <h2 id="the-hook-timing-bug">The Hook Timing Bug</h2> <p>With Puppeteer working, the pluginâ€¦ did nothing. No diagrams converted. Debug output showed the <code class="language-plaintext highlighter-rouge">:pre_render</code> hook firing, but <code class="language-plaintext highlighter-rouge">site.data["mermaid_prebuild_enabled"]</code> was nil.</p> <p>Jekyllâ€™s <code class="language-plaintext highlighter-rouge">:after_init</code> hook seemed like the right place to check if <code class="language-plaintext highlighter-rouge">mmdc</code> exists and store the result. But <code class="language-plaintext highlighter-rouge">site.data</code> doesnâ€™t persist between hooks the way I expected. By the time <code class="language-plaintext highlighter-rouge">:pre_render</code> runs on each document, the flag was gone.</p> <p>The fix: use <code class="language-plaintext highlighter-rouge">:post_read</code> instead of <code class="language-plaintext highlighter-rouge">:after_init</code>. At that point, site configuration and data are stable.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Jekyll</span><span class="o">::</span><span class="no">Hooks</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:site</span><span class="p">,</span> <span class="ss">:post_read</span> <span class="k">do</span> <span class="o">|</span><span class="n">site</span><span class="o">|</span>
  <span class="k">next</span> <span class="k">unless</span> <span class="no">Configuration</span><span class="p">.</span><span class="nf">enabled?</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
  
  <span class="n">site</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="s2">"mermaid_prebuild"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"enabled"</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="s2">"registry"</span> <span class="o">=&gt;</span> <span class="p">{}</span> <span class="p">}</span>
  <span class="no">Jekyll</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"MermaidPrebuild:"</span><span class="p">,</span> <span class="s2">"Initialized (mmdc </span><span class="si">#{</span><span class="no">MmdcWrapper</span><span class="p">.</span><span class="nf">version</span><span class="si">}</span><span class="s2">)"</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="code-fence-patterns">Code Fence Patterns</h2> <p>Markdown supports two fence styles. Backticks:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">```</span><span class="nl">mermaid
</span><span class="sb">graph LR
  A --&gt; B</span>
<span class="p">```</span>
</code></pre></div></div> <p>Or tildes:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">~~~</span><span class="nl">mermaid
</span><span class="sb">graph LR
  A --&gt; B</span>
<span class="p">~~~</span>
</code></pre></div></div> <p>Both can use 3+ fence characters. The plugin needed to handle either style and ensure the closing fence matches the opening fence in both character type and count.</p> <p>The regex:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sr">%r{
  ^(`{3,}|~{3,})mermaid</span><span class="se">\s</span><span class="sr">*</span><span class="se">\n</span><span class="sr">  # Opening: 3+ backticks or tildes
  (.*?)                        # Content (non-greedy)
  ^</span><span class="se">\1\s</span><span class="sr">*$                      # Closing: must match opener
}mx</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">\1</code> backreference ensures a block opened with four backticks closes with four backticks, not three tildes.</p> <p>To show these examples without converting them, the plugin respects fence nesting - mermaid blocks inside outer fences are preserved as code.</p> <h2 id="gem-extraction">Gem Extraction</h2> <p>Once the local plugin worked, extraction followed the same TDD pattern as the previous gems. Six modules:</p> <ol> <li>
<strong>Configuration</strong> - Parse <code class="language-plaintext highlighter-rouge">_config.yml</code> settings</li> <li>
<strong>MmdcWrapper</strong> - Shell out to <code class="language-plaintext highlighter-rouge">mmdc</code>, handle errors</li> <li>
<strong>DigestCalculator</strong> - MD5 for cache keys</li> <li>
<strong>Processor</strong> - Find and replace mermaid blocks</li> <li>
<strong>Generator</strong> - Copy SVGs to <code class="language-plaintext highlighter-rouge">_site/</code>
</li> <li>
<strong>Hooks</strong> - Wire into Jekyll lifecycle</li> </ol> <p>42 tests covering the module interfaces. The tests mock <code class="language-plaintext highlighter-rouge">mmdc</code> execution since you canâ€™t assume Puppeteer dependencies in CI.</p> <h2 id="coderabbits-review">CodeRabbitâ€™s Review</h2> <p>Three valid concerns after the initial push:</p> <p><strong>1. Cross-platform <code class="language-plaintext highlighter-rouge">which</code></strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Kernel</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s2">"which mmdc &gt; /dev/null 2&gt;&amp;1"</span><span class="p">)</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">which</code> command doesnâ€™t exist on Windows. <a href="https://github.com/Texarkanine/jekyll-mermaid-prebuild/blob/v0.2.0/lib/jekyll-mermaid-prebuild/mmdc_wrapper.rb#L20-L32" target="_blank" rel="noopener">Fixed with pure Ruby PATH scanning</a>:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">command_exists?</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="n">cmd_name</span> <span class="o">=</span> <span class="no">Gem</span><span class="p">.</span><span class="nf">win_platform?</span> <span class="p">?</span> <span class="s2">"</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">.exe"</span> <span class="p">:</span> <span class="n">cmd</span>
  <span class="n">path_dirs</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"PATH"</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="no">File</span><span class="o">::</span><span class="no">PATH_SEPARATOR</span><span class="p">)</span>
  
  <span class="n">path_dirs</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">executable?</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">cmd_name</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong>2. Windows Tempfile locking</strong></p> <p>The output Tempfile wasnâ€™t closed before <code class="language-plaintext highlighter-rouge">mmdc</code> tried to write to it. Windows locks open files, so <code class="language-plaintext highlighter-rouge">mmdc</code> would fail. Fixed by closing the tempfile before the subprocess runs.</p> <p><strong>3. Missing SVG handling</strong></p> <p>If a cached SVG somehow disappeared, <code class="language-plaintext highlighter-rouge">FileUtils.cp</code> would crash the build. <a href="https://github.com/Texarkanine/jekyll-mermaid-prebuild/blob/v0.2.0/lib/jekyll-mermaid-prebuild/hooks.rb#L23" target="_blank" rel="noopener">Added existence check</a> with a warning instead of hard failure.</p> <h2 id="examples-in-action">Examples in Action</h2> <p>The diagrams in my firmware debugging post now render as static SVGs. A flowchart that would have required 2MB of JavaScript:</p> <figure class="mermaid-diagram"> <a href="/assets/svg/e09440ca.svg" target="_blank" rel="noopener"><img src="/assets/svg/e09440ca.svg" alt="Mermaid Diagram" loading="lazy"></a> </figure> <p>The generated SVG is ~12KB. Wrapped in a link to itself for full-size viewing on complex diagrams.</p> <h2 id="final-stats">Final Stats</h2> <ul> <li><strong>47 tests, all passing</strong></li> <li><strong>70%+ code coverage</strong></li> <li>
<strong>Published to RubyGems:</strong> <a href="https://rubygems.org/gems/jekyll-mermaid-prebuild" target="_blank" rel="noopener">jekyll-mermaid-prebuild</a>
</li> <li>
<strong>Installation:</strong> <code class="language-plaintext highlighter-rouge">gem install jekyll-mermaid-prebuild</code>
</li> </ul> <p>Three gems now: <a href="https://rubygems.org/gems/jekyll-highlight-cards" target="_blank" rel="noopener">jekyll-highlight-cards</a> for styled link and image cards, <a href="https://rubygems.org/gems/jekyll-auto-thumbnails" target="_blank" rel="noopener">jekyll-auto-thumbnails</a> for automatic image optimization, and <a href="https://rubygems.org/gems/jekyll-mermaid-prebuild" target="_blank" rel="noopener">jekyll-mermaid-prebuild</a> for build-time diagram rendering.</p> <h2 id="what-i-learned">What I Learned</h2> <p><strong>Jekyllâ€™s <code class="language-plaintext highlighter-rouge">site.data</code> doesnâ€™t persist the way youâ€™d expect between hooks.</strong> Data set in <code class="language-plaintext highlighter-rouge">:after_init</code> may not be available in <code class="language-plaintext highlighter-rouge">:pre_render</code>. Use <code class="language-plaintext highlighter-rouge">:post_read</code> for site-wide state that needs to survive into document processing.</p> <p><strong>Puppeteer dependencies vary by platform.</strong> The error message when Chrome canâ€™t launch is cryptic (<code class="language-plaintext highlighter-rouge">cannot open shared object file</code>). Detecting this failure mode and printing the exact <code class="language-plaintext highlighter-rouge">apt-get</code> command saves users time.</p> <p><strong>Regex backreferences match fence styles elegantly.</strong> <code class="language-plaintext highlighter-rouge">^\1\s*$</code> ensures opening and closing fences match both in character and count. No need to track state between matches.</p> <p><strong>Windows file locking affects tempfiles.</strong> On Unix, an open file descriptor doesnâ€™t prevent other processes from writing. On Windows, it does. Close tempfiles before subprocesses write to them.</p> <p><strong>Pure Ruby PATH scanning beats shell commands for portability.</strong> <code class="language-plaintext highlighter-rouge">which</code> doesnâ€™t exist on Windows, <code class="language-plaintext highlighter-rouge">where</code> doesnâ€™t exist on Unix. Scanning <code class="language-plaintext highlighter-rouge">ENV["PATH"]</code> with <code class="language-plaintext highlighter-rouge">File.executable?</code> works everywhere.</p> <h2 id="the-repository">The Repository</h2> <p>The code is at <a href="https://github.com/Texarkanine/jekyll-mermaid-prebuild" target="_blank" rel="noopener">Texarkanine/jekyll-mermaid-prebuild</a> with the full implementation history.</p> <p>Three gems down, 2MB lighter per page.</p> </article> <footer> <p> tagged: <a href="/tags/jekyll/">jekyll</a>, <a href="/tags/mermaid/">mermaid</a>, <a href="/tags/ruby/">ruby</a>, <a href="/tags/rubygem/">rubygem</a> </p> </footer> <p> <a href="/">~</a> / <a href="/all-posts.html">..</a> </p> </div> </main> </body> </html>
